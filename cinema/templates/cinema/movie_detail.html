{% extends 'cinema/base.html' %}
{% load static %}

{% block content %}


<div class="w-full py-16 px-4">
  <div class="max-w-7xl mx-auto grid lg:grid-cols-2 gap-5 md:gap-8">
    <!-- aqui vem o video -->
    <div>
      <div class="bg-neutral-800 p-6 rounded-2xl">
        <h1 class="text-neutral-200 text-2xl font-bold">{{ movie.title }}</h1>
        <p class="text-neutral-300 text-sm md:text-lg font-light">{{ movie.year }} — {{ movie.length }}</p> 

        <form class="rating-stars text-neutral-700 text-3xl mt-2" action="{% url 'movie_rate' movie.id %}" method="post" url="">
          {% csrf_token %}
          <button type="submit" class="fa fa-star my-btn" id="first" name="score" value="1"></button>
          <button type="submit" class="fa fa-star my-btn" id="second" name="score" value="2"></button>
          <button type="submit" class="fa fa-star my-btn" id="third" name="score" value="3"></button>
          <button type="submit" class="fa fa-star my-btn" id="fourth" name="score" value="4"></button>
          <button type="submit" class="fa fa-star my-btn" id="fifth" name="score" value="5"></button>
        </form> 

        <hr class="text-neutral-700 lg:mx-auto h-px my-4">

        <div class="grid grid-cols-2">
          <div>
            <p class="text-neutral-300 text-sm md:text-lg font-light">{{ movie.genre }}</p>
            <p class="text-neutral-300 text-sm md:text-lg font-light">Dirigido por <span class="font-bold">{{ movie.director }}</span></p>
          </div>

          <div>
            <!-- save movie | depois vou colocar o icon como button pra save e unsave -->
            {% if movie in profile.saved_movies.all %}
              <a href="{% url 'save_movie' movie.id %}">unsave</a>
            {% else %}
              <a href="{% url 'save_movie' movie.id %}">save</a>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="botao-detalhe flex gap-4 mt-6">
        {% if request.user.is_superuser %}
        <a class="text-center text-neutral-400 border border-neutral-400 hover:text-neutral-50 hover:border-neutral-50 font-medium rounded-xl text-sm py-2 px-10" href="{% url 'update_movie' movie.id %}">editar filme</a>
        <button type="button" onclick="toggleModal(true)" class="text-center text-neutral-400 border border-neutral-400 hover:text-neutral-50 hover:border-neutral-50 font-medium rounded-xl text-sm py-2 px-10 cursor-pointer">deletar filme</button>

        <!-- como o delete está aqui agora, preciso arrumar a view depois para apontar pra cá -->
        <dialog id="deleteModal" class="fixed inset-0 size-auto max-h-none max-w-none overflow-y-auto bg-transparent backdrop:bg-transparent">
          <el-dialog-backdrop class="fixed inset-0 bg-neutral-900/50 transition-opacity data-closed:opacity-0 data-enter:duration-300 data-enter:ease-out data-leave:duration-200 data-leave:ease-in"></el-dialog-backdrop>
          <div tabindex="0" class="flex min-h-full items-end justify-center p-4 text-center focus:outline-none sm:items-center sm:p-0">
            <el-dialog-panel class="relative transform overflow-hidden rounded-lg bg-neutral-800 text-left shadow-xl transition-all data-closed:translate-y-4 data-closed:opacity-0 data-enter:duration-300 data-enter:ease-out data-leave:duration-200 data-leave:ease-in sm:my-8 sm:w-full sm:max-w-lg data-closed:sm:translate-y-0 data-closed:sm:scale-95">
              <div class="bg-neutral-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                  <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                    <h3 id="dialog-title" class="text-base font-semibold text-white">Excluir filme</h3>
                    <div class="mt-2">
                      <p class="text-sm text-neutral-400">Você tem certeza que deseja excluir "<span class="text-neutral-200 font-bold">{{ movie.title }}</span>" ? Todos os dados serão excluídos permanentemente e não poderão ser restaurados.</p>
                    </div>
                  </div>
                </div>
              </div>
              <div class="bg-neutral-700/25 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                <form method="post" action="{% url 'delete_movie' movie.id %}">
                  {% csrf_token %}
                  <button type="submit" class="inline-flex w-full justify-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white hover:bg-red-400 sm:ml-3 sm:w-auto cursor-pointer">excluir filme</button>
                </form>
                <button type="button" onclick="toggleModal(false)" class="mt-3 inline-flex w-full justify-center rounded-md bg-white/10 px-3 py-2 text-sm font-semibold text-white hover:bg-white/20 sm:mt-0 sm:w-auto cursor-pointer">cancelar</button>
              </div>
            </el-dialog-panel>
          </div>
        </dialog>
        {% endif %}
      </div>
    </div>


    <div>
      <h2 class="text-neutral-400 text-lg md:text-xl font-bold mb-3">Sinopse</h2>
      <p class="desc-1">{{ movie.synopsis }}</p>
    </div>
  </div>

  <hr class="max-w-7xl text-neutral-800 lg:mx-auto h-px my-8">

  <div class="max-w-7xl mx-auto mt-12">
    <div>
      <!-- alterar isso depois, nao preciso de uma template só pra comments -->
      <h1 class="text-xl md:text-2xl font-light text-neutral-200"><span class="font-bold">O que você achou do filme?</span> Compartilhe sua experiência.</h1>

      <form action="{% url 'movie_comment' movie.id %}" method="post" class="my-6">
        <div class="relative">
          {% csrf_token %}
          {{ comment_form.text.errors }}
          {{ comment_form.text }}
          <button class=" botao-filme text-neutral-900 absolute end-5 bottom-5 font-bold rounded-2xl text-sm px-6 py-2" type="submit">comentar</button>
        </div>
      </form>
    </div>

    <div class="comentario-lista mt-8">
      <h3 class="text-neutral-200 text-lg md:text-xl font-bold mb-7">Comentários <span class="qtd-comentario text-base font-bold rounded-2xl px-3">{{ comments.count }}</span></h3>

      <div class="flex">
        <div class="vl w-6 mr-6"></div>

        <div>
          {% for comment in comments %}
          <div>
            <p class="text-neutral-200 text-xl font-medium">{{ comment.user }} <span class="text-neutral-500 text-base font-light">{{ comment.created_date }}</span></p>
            <p class="desc-1 text-sm mt-1 mb-5">{{ comment.text }}</p>
          </div>
          {% endfor %}
        </div>
      </div>

    </div>
  </div>
</div>


<script>
  /* script for star rating */
  var score = parseInt('{{ user_rating.score }}')

  const one = document.getElementById('first')
  const two = document.getElementById('second')
  const three = document.getElementById('third')
  const four = document.getElementById('fourth')
  const five = document.getElementById('fifth')

  const form = document.querySelector('.rating-stars')

  const csrf = document.getElementsByName('csrfmiddlewaretoken')

  const handleStarSelect = (size) => {
    const children = form.children
    for (let i=0; i< children.length; i++) {
      if(i <= size) {
        children[i].classList.add('checked')
      } else {
        children[i].classList.remove('checked')
      }
    }
  }

  handleStarSelect(score)

  const handleSelect = (selection) => {
    switch(selection){
      case 'first': {
        handleStarSelect(1)
        return
      }
      case 'second': {
        handleStarSelect(2)
        return
      }
      case 'third': {
        handleStarSelect(3)
        return
      }
      case 'fourth': {
        handleStarSelect(4)
        return
      }
      case 'fifth': {
        handleStarSelect(5)
        return
      }
    }
  }

  if (one) {
    const arr = [one, two, three, four, five]
    arr.forEach(item=> item.addEventListener('mouseover', (event)=> {
      handleSelect(event.target.id)
    }))
  }

  /* script for delete movie */
  const modal = document.getElementById('deleteModal');

  function toggleModal(show) {
    if (show) {
      modal.showModal();
    } else {
      modal.close();
    }
  }

</script>

{% endblock content %}